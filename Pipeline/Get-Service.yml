- name: win_powershell
  vars:
    ServiceName: WinRM
    State: None
  hosts: ws
  tasks:
    - name: Get service state
      win_shell: |
        Get-Service *"{{ServiceName}}"*
      register: command_output
    - name: Output
      debug:
        var: command_output.stdout_lines
    - name: Change service state
      win_shell: |
        if ("{{State}}" -match "Start") {
          Start-Service *"{{ServiceName}}"*
        }
        elseif ("{{State}}" -match "Restart") {
          Restart-Service *"{{ServiceName}}"*
        }
        elseif ("{{State}}" -match "Stop") {
          Stop-Service *"{{ServiceName}}"*
        }
        else {
          Write-Host "No change in state"
        }
        if ("{{State}}" -match "Start|Restart|Stop") {    
          Get-Service *"{{ServiceName}}"*
        }
      register: command_output
    - name: Output
      debug:
        var: command_output.stdout_lines